<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Timeline</title>
        <style>
            :root {
                --bg-body: #1a1a2e;
                --bg-card: #16213e;
                --bg-control: #0f0f23;
                --accent: #4cc9f0;
                --text: #eee;
                --text-muted: #888;
                --text-dim: #aaa;
                --border: #444;
                --label-width: 250px;
            }
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: var(--bg-body);
                color: var(--text);
                padding: 20px;
            }
            h1 {
                text-align: center;
                margin-bottom: 30px;
            }
            .container {
                max-width: 1400px;
                margin: 0 auto;
            }
            .chart-wrapper {
                position: relative;
            }
            .chart-controls {
                position: absolute;
                bottom: 0;
                right: 10px;
                display: flex;
                gap: 10px;
                background: var(--bg-control);
                padding: 6px 8px;
                border-radius: 6px;
            }
            .control-group {
                display: flex;
                gap: 5px;
                align-items: center;
            }
            .control-group:not(:last-child) {
                padding-right: 10px;
                border-right: 1px solid var(--border);
            }
            .zoom-btn {
                width: 32px;
                height: 32px;
                border: 1px solid var(--border);
                background: var(--bg-card);
                color: var(--text);
                border-radius: 4px;
                cursor: pointer;
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .zoom-btn:hover {
                background: var(--bg-body);
            }
            .zoom-level {
                color: var(--text-muted);
                font-size: 12px;
                padding: 0 8px;
            }
            .size-slider {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .size-option,
            .sort-option {
                color: var(--text-muted);
                font-size: 11px;
                cursor: pointer;
            }
            .size-option.active,
            .sort-option.active {
                color: var(--accent);
                font-weight: bold;
            }
            .slider-input {
                width: 60px;
                height: 4px;
                appearance: none;
                background: var(--bg-card);
                border-radius: 2px;
                cursor: pointer;
            }
            .slider-input::-webkit-slider-thumb {
                appearance: none;
                width: 14px;
                height: 14px;
                background: var(--accent);
                border-radius: 50%;
                cursor: pointer;
            }
            .slider-input::-moz-range-thumb {
                width: 14px;
                height: 14px;
                background: var(--accent);
                border-radius: 50%;
                cursor: pointer;
                border: none;
            }
            .chart-container {
                background: var(--bg-card);
                border-radius: 0 0 8px 8px;
                overflow-x: auto;
                overflow-y: visible;
            }
            .year-header-wrapper {
                position: sticky;
                top: 0;
                z-index: 20;
                background: var(--bg-card);
                overflow: hidden;
                border-radius: 8px 8px 0 0;
                padding-bottom: 40px;
            }
            .chart {
                height: auto;
                position: relative;
            }
            .year-header {
                display: flex;
                background: var(--bg-card);
                height: 40px;
                align-items: center;
            }
            .year-header-spacer {
                width: var(--label-width);
                flex-shrink: 0;
                background: var(--bg-card);
            }
            .year-header-timeline {
                flex: 1;
                position: relative;
                height: 100%;
                display: flex;
                align-items: center;
                padding-right: 100px;
            }
            .year-header-label {
                position: absolute;
                transform: translateX(-50%);
                font-size: 12px;
                color: rgba(255, 255, 255, 0.6);
                font-weight: bold;
            }
            .series-row {
                display: flex;
                align-items: stretch;
                min-height: 50px;
            }
            .series-label {
                width: var(--label-width);
                flex-shrink: 0;
                font-size: 14px;
                padding-right: 15px;
                text-align: right;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                position: sticky;
                left: 0;
                background: var(--bg-card);
                z-index: 10;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }
            .series-timeline {
                flex: 1;
                position: relative;
                height: 40px;
                padding-right: 100px;
            }
            .episode {
                position: absolute;
                width: 14px;
                height: 14px;
                border-radius: 50%;
                transform: translate(-50%, -50%);
                top: 50%;
                cursor: pointer;
                transition:
                    transform 0.2s,
                    box-shadow 0.2s;
                border: 2px solid rgba(255, 255, 255, 0.3);
            }
            .episode:hover {
                transform: translate(-50%, -50%) scale(1.5);
                box-shadow: 0 0 15px currentColor;
                z-index: 100;
            }
            .series-line {
                position: absolute;
                height: 3px;
                top: 50%;
                transform: translateY(-50%);
                border-radius: 2px;
                opacity: 0.5;
            }
            .year-lines {
                position: absolute;
                top: 0;
                left: var(--label-width);
                right: 0;
                bottom: 0;
                pointer-events: none;
                padding-right: 100px;
            }
            .year-line {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 1px;
                background: rgba(255, 255, 255, 0.1);
            }
            .tooltip {
                position: fixed;
                background: var(--bg-control);
                border: 1px solid var(--border);
                padding: 12px;
                border-radius: 8px;
                font-size: 13px;
                max-width: 400px;
                pointer-events: none;
                z-index: 1000;
                display: none;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            }
            .tooltip-thumbnail {
                width: 150px;
                border-radius: 4px;
                margin-bottom: 10px;
            }
            .tooltip-title {
                font-weight: bold;
                margin-bottom: 8px;
                line-height: 1.3;
            }
            .tooltip-meta {
                display: flex;
                flex-wrap: wrap;
                gap: 8px 16px;
                margin-bottom: 8px;
                color: var(--text-dim);
                font-size: 12px;
            }
            .tooltip-meta span {
                display: flex;
                align-items: center;
                gap: 4px;
            }
            .tooltip-description {
                color: var(--text-muted);
                font-size: 12px;
                line-height: 1.4;
                max-height: 120px;
                overflow: hidden;
                display: -webkit-box;
                -webkit-line-clamp: 6;
                -webkit-box-orient: vertical;
            }
            .stats {
                margin-bottom: 30px;
                padding: 15px;
                background: var(--bg-card);
                border-radius: 8px;
            }
            .stats h3 {
                margin-bottom: 15px;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            .stat-card {
                background: var(--bg-body);
                padding: 15px;
                border-radius: 6px;
            }
            .stat-value {
                font-size: 24px;
                font-weight: bold;
                color: var(--accent);
            }
            .stat-label {
                font-size: 12px;
                color: var(--text-muted);
                margin-top: 5px;
            }
            @media (max-width: 768px) {
                :root {
                    --label-width: 100px;
                }
                .series-label {
                    font-size: 11px;
                    padding-right: 8px;
                    white-space: normal;
                    line-height: 1.2;
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    -webkit-box-orient: vertical;
                }
                .size-option[data-value="standard"] {
                    display: none;
                }
                .control-group:has(.sort-option) {
                    display: none;
                }
                .control-group:has(.size-option) {
                    border-right: none;
                    padding-right: 0;
                }
                .chart-controls {
                    right: 50%;
                    transform: translateX(50%);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>2d6+Cool - Timeline</h1>
            <div class="stats" id="stats"></div>
            <div class="chart-wrapper">
                <div class="year-header-wrapper">
                    <div class="year-header" id="yearHeader"></div>
                    <div class="chart-controls">
                        <div class="control-group">
                            <button class="zoom-btn" id="zoomOut">‚àí</button>
                            <span class="zoom-level" id="zoomLevel">100%</span>
                            <button class="zoom-btn" id="zoomIn">+</button>
                            <button class="zoom-btn" id="zoomReset">‚Ü∫</button>
                        </div>
                        <div class="control-group">
                            <div class="size-slider">
                                <span class="size-option" data-value="standard"
                                    >Standard</span
                                >
                                <input
                                    type="range"
                                    min="0"
                                    max="2"
                                    value="0"
                                    id="sizeSlider"
                                    class="slider-input"
                                />
                                <span class="size-option" data-value="views"
                                    >Vues</span
                                >
                                <span class="size-option" data-value="likes"
                                    >J'aime</span
                                >
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="size-slider">
                                <span class="sort-option" data-value="first"
                                    >1er √©pisode</span
                                >
                                <input
                                    type="range"
                                    min="0"
                                    max="1"
                                    value="1"
                                    id="sortSlider"
                                    class="slider-input"
                                />
                                <span
                                    class="sort-option active"
                                    data-value="last"
                                    >Dernier √©pisode</span
                                >
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-container" id="chartContainer">
                    <div class="chart" id="chart"></div>
                </div>
            </div>
        </div>
        <div class="tooltip" id="tooltip"></div>

        <script>
            const colors = [
                "#e63946",
                "#f4a261",
                "#2a9d8f",
                "#264653",
                "#e9c46a",
                "#9b59b6",
                "#3498db",
                "#1abc9c",
                "#e74c3c",
                "#f39c12",
                "#8e44ad",
                "#2980b9",
                "#27ae60",
                "#d35400",
                "#c0392b",
                "#16a085",
                "#8e44ad",
                "#2c3e50",
                "#f1c40f",
                "#e67e22",
                "#9b59b6",
                "#1abc9c",
                "#34495e",
                "#e91e63",
                "#00bcd4",
                "#4caf50",
                "#ff9800",
                "#795548",
                "#607d8b",
                "#3f51b5",
            ];
            const $ = (id) => document.getElementById(id);
            const $$ = (sel) => document.querySelectorAll(sel);

            let videosData = null,
                zoomLevel = 1,
                sizeMode = "standard",
                sortMode = "last";
            const [minZoom, maxZoom, baseWidth, minCircleSize, maxCircleSize] =
                [0.5, 4, 2500, 6, 40];

            const updateZoom = () => {
                const w = baseWidth * zoomLevel + "px";
                $("chart").style.minWidth = $("yearHeader").style.minWidth = w;
                $("zoomLevel").textContent = Math.round(zoomLevel * 100) + "%";
            };

            const setupControls = () => {
                const container = $("chartContainer");

                $("zoomIn").onclick = () => {
                    zoomLevel = Math.min(maxZoom, zoomLevel * 1.25);
                    updateZoom();
                };
                $("zoomOut").onclick = () => {
                    zoomLevel = Math.max(minZoom, zoomLevel / 1.25);
                    updateZoom();
                };
                $("zoomReset").onclick = () => {
                    zoomLevel = 1;
                    updateZoom();
                };

                container.addEventListener(
                    "wheel",
                    (e) => {
                        if (!e.ctrlKey && !e.metaKey) return;
                        e.preventDefault();
                        const rect = container.getBoundingClientRect();
                        const mouseX =
                            e.clientX - rect.left + container.scrollLeft;
                        const oldZoom = zoomLevel;
                        zoomLevel =
                            e.deltaY < 0
                                ? Math.min(maxZoom, zoomLevel * 1.1)
                                : Math.max(minZoom, zoomLevel / 1.1);
                        updateZoom();
                        container.scrollLeft =
                            mouseX * (zoomLevel / oldZoom) -
                            (e.clientX - rect.left);
                    },
                    { passive: false },
                );

                const setupSlider = (sliderId, options, modes, onChange) => {
                    const slider = $(sliderId);
                    const updateUI = () =>
                        options.forEach((o, i) =>
                            o.classList.toggle("active", i === +slider.value),
                        );
                    slider.oninput = () => {
                        onChange(modes[slider.value]);
                        updateUI();
                    };
                    options.forEach(
                        (o, i) =>
                            (o.onclick = () => {
                                slider.value = i;
                                onChange(modes[i]);
                                updateUI();
                            }),
                    );
                    updateUI();
                };

                setupSlider(
                    "sizeSlider",
                    [...$$(".size-option")],
                    ["standard", "views", "likes"],
                    (m) => {
                        sizeMode = m;
                        updateCircleSizes();
                    },
                );
                setupSlider(
                    "sortSlider",
                    [...$$(".sort-option")],
                    ["first", "last"],
                    (m) => {
                        sortMode = m;
                        renderTimeline();
                    },
                );

                container.onscroll = () =>
                    ($("yearHeader").style.transform =
                        `translateX(-${container.scrollLeft}px)`);
            };

            const updateCircleSizes = () => {
                if (!videosData) return;
                const videos = videosData.videos;
                const getRange = (key) => {
                    const vals = videos.map((v) => v[key] || 0);
                    return [Math.min(...vals), Math.max(...vals)];
                };
                const [minViews, maxViews] = getRange("viewCount");
                const [minLikes, maxLikes] = getRange("likeCount");

                $$(".episode").forEach((ep) => {
                    let size = 14;
                    if (sizeMode !== "standard") {
                        const [value, min, max] =
                            sizeMode === "views"
                                ? [+ep.dataset.views || 0, minViews, maxViews]
                                : [+ep.dataset.likes || 0, minLikes, maxLikes];
                        const norm = (value - min) / (max - min || 1);
                        const [minA, maxA] = [
                            Math.PI * (minCircleSize / 2) ** 2,
                            Math.PI * (maxCircleSize / 2) ** 2,
                        ];
                        size =
                            2 *
                            Math.sqrt((minA + norm * (maxA - minA)) / Math.PI);
                    }
                    ep.style.width = ep.style.height = size + "px";
                });
            };

            const loadData = async () => {
                try {
                    videosData = await (
                        await fetch("./data/videos.json")
                    ).json();
                    renderTimeline();
                    updateCircleSizes();
                    $("chartContainer").scrollLeft =
                        $("chartContainer").scrollWidth;
                } catch (e) {
                    $("chart").innerHTML =
                        '<p style="padding:20px">Erreur lors du chargement de videos.json.</p>';
                }
            };

            const renderTimeline = () => {
                const videos = videosData.videos;
                const seriesMap = new Map();
                videos.forEach((v) => {
                    const s = v.serie || "Unknown";
                    if (!seriesMap.has(s)) seriesMap.set(s, []);
                    seriesMap.get(s).push(v);
                });

                const sortedSeries = [...seriesMap.entries()]
                    .map(([name, eps]) => ({
                        name,
                        episodes: eps.sort(
                            (a, b) =>
                                new Date(a.publishedAt) -
                                new Date(b.publishedAt),
                        ),
                    }))
                    .sort((a, b) => {
                        const getDate = (s) =>
                            new Date(
                                s.episodes[
                                    sortMode === "first"
                                        ? 0
                                        : s.episodes.length - 1
                                ].publishedAt,
                            );
                        return getDate(b) - getDate(a);
                    });

                const allDates = videos.map((v) => new Date(v.publishedAt));
                const minDate = new Date(Math.min(...allDates)),
                    maxDate = new Date(Math.max(...allDates));
                minDate.setMonth(minDate.getMonth() - 1);
                maxDate.setMonth(maxDate.getMonth() + 6);
                const totalMs = maxDate - minDate;
                const toPos = (d) => ((d - minDate) / totalMs) * 100;

                const years = [];
                for (
                    let y = minDate.getFullYear();
                    y <= maxDate.getFullYear();
                    y++
                ) {
                    const d = new Date(y, 0, 1);
                    if (d >= minDate && d <= maxDate)
                        years.push({ year: y, pos: toPos(d) });
                }

                $("yearHeader").innerHTML =
                    `<div class="year-header-spacer"></div><div class="year-header-timeline">${years.map((y) => `<div class="year-header-label" style="left:${y.pos}%">${y.year}</div>`).join("")}</div>`;

                $("chart").innerHTML =
                    `<div class="year-lines">${years.map((y) => `<div class="year-line" style="left:${y.pos}%"></div>`).join("")}</div>` +
                    sortedSeries
                        .map((s, i) => {
                            const color = colors[i % colors.length];
                            const eps = s.episodes;
                            const firstPos = toPos(
                                new Date(eps[0].publishedAt),
                            );
                            const lastPos = toPos(
                                new Date(eps[eps.length - 1].publishedAt),
                            );
                            const circles = eps
                                .map((ep) => {
                                    const pos = toPos(new Date(ep.publishedAt));
                                    const thumb =
                                        ep.thumbnails?.medium?.url ||
                                        ep.thumbnails?.default?.url ||
                                        "";
                                    const desc = (ep.description || "")
                                        .replace(/"/g, "&quot;")
                                        .replace(/\n/g, " ");
                                    const date = new Date(
                                        ep.publishedAt,
                                    ).toLocaleDateString("fr-FR", {
                                        year: "numeric",
                                        month: "long",
                                        day: "numeric",
                                    });
                                    return `<div class="episode" style="left:${pos}%;background:${color};color:${color}" data-title="${ep.title.replace(/"/g, "&quot;")}" data-date="${date}" data-duration="${ep.durationFormatted}" data-views="${ep.viewCount || 0}" data-likes="${ep.likeCount || 0}" data-comments="${ep.commentCount || 0}" data-thumbnail="${thumb}" data-description="${desc}" data-url="${ep.url}"></div>`;
                                })
                                .join("");
                            return `<div class="series-row"><div class="series-label" title="${s.name}">${s.name}</div><div class="series-timeline"><div class="series-line" style="left:${firstPos}%;width:${lastPos - firstPos}%;background:${color}"></div>${circles}</div></div>`;
                        })
                        .join("");

                const tooltip = $("tooltip");
                $$(".episode").forEach((ep) => {
                    ep.onmouseenter = () => {
                        const thumb = ep.dataset.thumbnail
                            ? `<img class="tooltip-thumbnail" src="${ep.dataset.thumbnail}">`
                            : "";
                        const desc = ep.dataset.description
                            ? `<div class="tooltip-description">${ep.dataset.description}</div>`
                            : "";
                        tooltip.innerHTML = `${thumb}<div class="tooltip-title">${ep.dataset.title}</div><div class="tooltip-meta"><span>üìÖ ${ep.dataset.date}</span><span>‚è±Ô∏è ${ep.dataset.duration}</span><span>üëÅÔ∏è ${(+ep.dataset.views).toLocaleString()}</span><span>üëç ${(+ep.dataset.likes).toLocaleString()}</span><span>üí¨ ${(+ep.dataset.comments).toLocaleString()}</span></div>${desc}`;
                        tooltip.style.display = "block";
                    };
                    ep.onmousemove = (e) => {
                        const r = tooltip.getBoundingClientRect();
                        let left = e.clientX + 15,
                            top = e.clientY + 15;
                        if (left + r.width > innerWidth)
                            left = e.clientX - r.width - 15;
                        if (top + r.height > innerHeight)
                            top = e.clientY - r.height - 15;
                        tooltip.style.left = Math.max(10, left) + "px";
                        tooltip.style.top = Math.max(10, top) + "px";
                    };
                    ep.onmouseleave = () => (tooltip.style.display = "none");
                    ep.onclick = () => window.open(ep.dataset.url, "_blank");
                });

                const total = videos.length;
                const totalDur = videos.reduce(
                    (s, v) => s + (v.durationSeconds || 0),
                    0,
                );
                $("stats").innerHTML =
                    `<h3>Statistiques</h3><div class="stats-grid"><div class="stat-card"><div class="stat-value">${sortedSeries.length}</div><div class="stat-label">S√©ries</div></div><div class="stat-card"><div class="stat-value">${total}</div><div class="stat-label">√âpisodes au total</div></div><div class="stat-card"><div class="stat-value">${Math.floor(totalDur / 3600)}h</div><div class="stat-label">Dur√©e totale</div></div><div class="stat-card"><div class="stat-value">${Math.floor(totalDur / total / 60)}min</div><div class="stat-label">Dur√©e moyenne par √©pisode</div></div></div>`;
            };

            loadData();
            setupControls();
            updateZoom();
        </script>
    </body>
</html>
