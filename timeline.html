<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Series Timeline</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: #1a1a2e;
                color: #eee;
                padding: 20px;
            }

            h1 {
                text-align: center;
                margin-bottom: 30px;
                color: #fff;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
            }

            .timeline {
                position: relative;
                padding: 20px 0;
            }

            .chart-container {
                background: #16213e;
                border-radius: 8px;
                overflow-x: auto;
                max-height: 80vh;
                overflow-y: auto;
            }

            .chart {
                min-width: 2500px;
                height: auto;
                position: relative;
            }

            .year-header {
                display: flex;
                position: sticky;
                top: 0;
                background: #16213e;
                z-index: 20;
                min-width: 2500px;
                height: 40px;
                align-items: center;
            }

            .year-header-spacer {
                width: 250px;
                flex-shrink: 0;
                background: #16213e;
            }

            .year-header-timeline {
                flex: 1;
                position: relative;
                height: 100%;
                display: flex;
                align-items: center;
            }

            .year-header-label {
                position: absolute;
                transform: translateX(-50%);
                font-size: 12px;
                color: rgba(255, 255, 255, 0.6);
                font-weight: bold;
            }

            .series-row {
                display: flex;
                align-items: center;
                margin-bottom: 15px;
                min-height: 40px;
            }

            .series-label {
                width: 250px;
                flex-shrink: 0;
                font-size: 14px;
                padding-right: 15px;
                text-align: right;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                position: sticky;
                left: 0;
                background: #16213e;
                z-index: 10;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }

            .series-timeline {
                flex: 1;
                position: relative;
                height: 40px;
            }

            .episode {
                position: absolute;
                width: 14px;
                height: 14px;
                border-radius: 50%;
                transform: translate(-50%, -50%);
                top: 50%;
                cursor: pointer;
                transition:
                    transform 0.2s,
                    box-shadow 0.2s;
                border: 2px solid rgba(255, 255, 255, 0.3);
            }

            .episode:hover {
                transform: translate(-50%, -50%) scale(1.5);
                box-shadow: 0 0 15px currentColor;
                z-index: 100;
            }

            .series-line {
                position: absolute;
                height: 3px;
                top: 50%;
                transform: translateY(-50%);
                border-radius: 2px;
                opacity: 0.5;
            }

            .year-lines {
                position: absolute;
                top: 0;
                left: 250px;
                right: 0;
                bottom: 0;
                pointer-events: none;
            }

            .year-line {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 1px;
                background: rgba(255, 255, 255, 0.1);
            }

            .year-line-label {
                display: none;
            }

            .tooltip {
                position: fixed;
                background: #0f0f23;
                border: 1px solid #444;
                padding: 12px;
                border-radius: 8px;
                font-size: 13px;
                max-width: 350px;
                pointer-events: none;
                z-index: 1000;
                display: none;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            }

            .tooltip-title {
                font-weight: bold;
                margin-bottom: 8px;
                color: #fff;
            }

            .tooltip-date {
                color: #aaa;
                margin-bottom: 4px;
            }

            .tooltip-duration {
                color: #888;
            }

            .stats {
                margin-bottom: 30px;
                padding: 15px;
                background: #16213e;
                border-radius: 8px;
            }

            .stats h3 {
                margin-bottom: 15px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .stat-card {
                background: #1a1a2e;
                padding: 15px;
                border-radius: 6px;
            }

            .stat-value {
                font-size: 24px;
                font-weight: bold;
                color: #4cc9f0;
            }

            .stat-label {
                font-size: 12px;
                color: #888;
                margin-top: 5px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>2d6+Cool - Series Timeline</h1>

            <div class="stats" id="stats"></div>

            <div class="chart-container">
                <div class="year-header" id="yearHeader"></div>
                <div class="chart" id="chart"></div>
            </div>
        </div>

        <div class="tooltip" id="tooltip"></div>

        <script>
            // Color palette for series
            const colors = [
                "#e63946",
                "#f4a261",
                "#2a9d8f",
                "#264653",
                "#e9c46a",
                "#9b59b6",
                "#3498db",
                "#1abc9c",
                "#e74c3c",
                "#f39c12",
                "#8e44ad",
                "#2980b9",
                "#27ae60",
                "#d35400",
                "#c0392b",
                "#16a085",
                "#8e44ad",
                "#2c3e50",
                "#f1c40f",
                "#e67e22",
                "#9b59b6",
                "#1abc9c",
                "#34495e",
                "#e91e63",
                "#00bcd4",
                "#4caf50",
                "#ff9800",
                "#795548",
                "#607d8b",
                "#3f51b5",
            ];

            let videosData = null;

            async function loadData() {
                try {
                    const response = await fetch("./data/videos.json");
                    videosData = await response.json();
                    renderTimeline();
                } catch (error) {
                    console.error("Error loading data:", error);
                    document.getElementById("chart").innerHTML =
                        '<p style="padding: 20px;">Error loading videos.json. Make sure to serve this file from a web server.</p>';
                }
            }

            function renderTimeline() {
                const videos = videosData.videos;

                // Group videos by series
                const seriesMap = new Map();
                videos.forEach((video) => {
                    const serie = video.serie || "Unknown";
                    if (!seriesMap.has(serie)) {
                        seriesMap.set(serie, []);
                    }
                    seriesMap.get(serie).push(video);
                });

                // Sort series by first episode date
                const sortedSeries = Array.from(seriesMap.entries())
                    .map(([name, episodes]) => ({
                        name,
                        episodes: episodes.sort(
                            (a, b) =>
                                new Date(a.publishedAt) -
                                new Date(b.publishedAt),
                        ),
                    }))
                    .sort(
                        (a, b) =>
                            new Date(a.episodes[0].publishedAt) -
                            new Date(b.episodes[0].publishedAt),
                    );

                // Assign colors to series
                const seriesColors = new Map();
                sortedSeries.forEach((serie, index) => {
                    seriesColors.set(serie.name, colors[index % colors.length]);
                });

                // Find date range
                const allDates = videos.map((v) => new Date(v.publishedAt));
                const minDate = new Date(Math.min(...allDates));
                const maxDate = new Date(Math.max(...allDates));

                // Add some padding to the date range
                minDate.setMonth(minDate.getMonth() - 1);
                maxDate.setMonth(maxDate.getMonth() + 1);

                const totalMs = maxDate - minDate;

                // Generate year lines
                const years = [];
                const startYear = minDate.getFullYear();
                const endYear = maxDate.getFullYear();
                for (let year = startYear; year <= endYear; year++) {
                    const yearDate = new Date(year, 0, 1);
                    if (yearDate >= minDate && yearDate <= maxDate) {
                        const pos = ((yearDate - minDate) / totalMs) * 100;
                        years.push({ year, pos });
                    }
                }

                const yearLinesHtml = `
                    <div class="year-lines">
                        ${years
                            .map(
                                (y) => `
                            <div class="year-line" style="left: ${y.pos}%;">
                                <div class="year-line-label">${y.year}</div>
                            </div>
                        `,
                            )
                            .join("")}
                    </div>
                `;

                // Render sticky year header
                const yearHeaderEl = document.getElementById("yearHeader");
                yearHeaderEl.innerHTML = `
                    <div class="year-header-spacer"></div>
                    <div class="year-header-timeline">
                        ${years.map((y) => `<div class="year-header-label" style="left: ${y.pos}%;">${y.year}</div>`).join("")}
                    </div>
                `;

                // Render chart
                const chartEl = document.getElementById("chart");
                chartEl.innerHTML =
                    yearLinesHtml +
                    sortedSeries
                        .map((serie) => {
                            const color = seriesColors.get(serie.name);
                            const episodes = serie.episodes;

                            // Calculate line position (from first to last episode)
                            const firstPos =
                                ((new Date(episodes[0].publishedAt) - minDate) /
                                    totalMs) *
                                100;
                            const lastPos =
                                ((new Date(
                                    episodes[episodes.length - 1].publishedAt,
                                ) -
                                    minDate) /
                                    totalMs) *
                                100;

                            const episodeCircles = episodes
                                .map((ep) => {
                                    const pos =
                                        ((new Date(ep.publishedAt) - minDate) /
                                            totalMs) *
                                        100;
                                    return `<div class="episode"
            style="left: ${pos}%; background: ${color}; color: ${color};"
            data-title="${ep.title.replace(/"/g, "&quot;")}"
            data-date="${new Date(ep.publishedAt).toLocaleDateString("fr-FR", { year: "numeric", month: "long", day: "numeric" })}"
            data-duration="${ep.durationFormatted}"
            data-url="${ep.url}"
            data-serie="${serie.name}"></div>`;
                                })
                                .join("");

                            return `
          <div class="series-row" data-serie="${serie.name}">
            <div class="series-label" title="${serie.name}">${serie.name}</div>
            <div class="series-timeline">
              <div class="series-line" style="left: ${firstPos}%; width: ${lastPos - firstPos}%; background: ${color};"></div>
              ${episodeCircles}
            </div>
          </div>
        `;
                        })
                        .join("");

                // Setup tooltip
                const tooltip = document.getElementById("tooltip");
                chartEl.querySelectorAll(".episode").forEach((ep) => {
                    ep.addEventListener("mouseenter", (e) => {
                        tooltip.innerHTML = `
            <div class="tooltip-title">${ep.dataset.title}</div>
            <div class="tooltip-date">${ep.dataset.date}</div>
            <div class="tooltip-duration">Duration: ${ep.dataset.duration}</div>
          `;
                        tooltip.style.display = "block";
                    });

                    ep.addEventListener("mousemove", (e) => {
                        tooltip.style.left = e.clientX + 15 + "px";
                        tooltip.style.top = e.clientY + 15 + "px";
                    });

                    ep.addEventListener("mouseleave", () => {
                        tooltip.style.display = "none";
                    });

                    ep.addEventListener("click", () => {
                        window.open(ep.dataset.url, "_blank");
                    });
                });

                // Render stats
                const statsEl = document.getElementById("stats");
                const totalEpisodes = videos.length;
                const totalDuration = videos.reduce(
                    (sum, v) => sum + (v.durationSeconds || 0),
                    0,
                );
                const avgDuration = totalDuration / totalEpisodes;

                statsEl.innerHTML = `
        <h3>Statistics</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">${sortedSeries.length}</div>
            <div class="stat-label">Series</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${totalEpisodes}</div>
            <div class="stat-label">Total Episodes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${Math.floor(totalDuration / 3600)}h</div>
            <div class="stat-label">Total Duration</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${Math.floor(avgDuration / 60)}min</div>
            <div class="stat-label">Average Episode Duration</div>
          </div>
        </div>
      `;
            }

            loadData();
        </script>
    </body>
</html>
